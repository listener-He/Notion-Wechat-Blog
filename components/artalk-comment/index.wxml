<!--components/artalk-comment/index.wxml-->
<view wx:if="{{show}}" class="artalk-comment">
  <!-- è¯„è®ºæ ‡é¢˜æ  -->
  <view class="comment-header">
    <view class="comment-title">
      <text class="title-icon">ğŸ’¬</text>
      <text class="title-text">è¯„è®º ({{commentCount}})</text>
    </view>
    <view class="comment-actions">
      <view class="action-btn" bindtap="refreshComments">
        <text class="action-icon">ğŸ”„</text>
        <text class="action-text">åˆ·æ–°</text>
      </view>
      <view class="action-btn primary" bindtap="showCommentForm">
        <text class="action-icon">âœï¸</text>
        <text class="action-text">å†™è¯„è®º</text>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºè¡¨å• -->
  <view wx:if="{{showCommentForm}}" class="comment-form">
    <view class="form-header">
      <text class="form-title">
        {{replyToId ? 'å›å¤ @' + replyToName : 'å‘è¡¨è¯„è®º'}}
      </text>
      <view class="form-close" bindtap="hideCommentForm">
        <text class="close-icon">âœ•</text>
      </view>
    </view>
    
    <view class="form-content">
      <!-- è¯„è®ºå†…å®¹ -->
      <view class="input-group">
        <textarea 
          class="comment-textarea"
          placeholder="{{replyToId ? 'å†™ä¸‹ä½ çš„å›å¤...' : 'å†™ä¸‹ä½ çš„è¯„è®º...'}}"
          value="{{commentContent}}"
          bindinput="onInputChange"
          data-field="commentContent"
          maxlength="500"
          auto-height
        ></textarea>
        <view class="textarea-counter">{{commentContent.length}}/500</view>
      </view>
      
      <!-- ä½œè€…ä¿¡æ¯ -->
      <view class="author-info">
        <view class="input-row">
          <input 
            class="author-input"
            placeholder="æ˜µç§° *"
            value="{{authorName}}"
            bindinput="onInputChange"
            data-field="authorName"
            maxlength="20"
          />
          <input 
            class="author-input"
            placeholder="é‚®ç®±"
            value="{{authorEmail}}"
            bindinput="onInputChange"
            data-field="authorEmail"
            maxlength="50"
          />
        </view>
        <input 
          class="author-input website"
          placeholder="ç½‘ç«™ (å¯é€‰)"
          value="{{authorWebsite}}"
          bindinput="onInputChange"
          data-field="authorWebsite"
          maxlength="100"
        />
      </view>
      
      <!-- æäº¤æŒ‰é’® -->
      <view class="form-actions">
        <button 
          class="submit-btn {{submitting ? 'loading' : ''}}"
          bindtap="submitComment"
          disabled="{{submitting}}"
        >
          <text wx:if="{{submitting}}" class="loading-icon">â³</text>
          <text class="btn-text">{{submitting ? 'æäº¤ä¸­...' : 'æäº¤è¯„è®º'}}</text>
        </button>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºåˆ—è¡¨ -->
  <view class="comment-list">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading && comments.length === 0}}" class="comment-loading">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½è¯„è®ºä¸­...</text>
    </view>
    
    <!-- é”™è¯¯çŠ¶æ€ -->
    <view wx:elif="{{error}}" class="comment-error">
      <text class="error-icon">âš ï¸</text>
      <text class="error-text">{{error}}</text>
      <button class="retry-btn" bindtap="refreshComments">é‡è¯•</button>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{comments.length === 0}}" class="comment-empty">
      <text class="empty-icon">ğŸ’­</text>
      <text class="empty-title">æš‚æ— è¯„è®º</text>
      <text class="empty-text">æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</text>
      <button class="empty-btn" bindtap="showCommentForm">å†™è¯„è®º</button>
    </view>
    
    <!-- è¯„è®ºå†…å®¹ -->
    <view wx:else>
      <view wx:for="{{comments}}" wx:key="id" class="comment-item">
        <!-- ä¸»è¯„è®º -->
        <view class="comment-main">
          <view class="comment-avatar">
            <text class="avatar-emoji">{{item.author.avatar}}</text>
          </view>
          <view class="comment-content">
            <view class="comment-meta">
              <text class="author-name">{{item.author.name}}</text>
              <text class="comment-time">{{formatTime(item.createdAt)}}</text>
            </view>
            <view class="comment-text">{{item.content}}</view>
            <view class="comment-actions">
              <view 
                class="action-reply"
                bindtap="replyToComment"
                data-id="{{item.id}}"
                data-name="{{item.author.name}}"
              >
                <text class="reply-icon">â†©ï¸</text>
                <text class="reply-text">å›å¤</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- å›å¤åˆ—è¡¨ -->
        <view wx:if="{{item.replies.length > 0}}" class="reply-list">
          <view wx:for="{{item.replies}}" wx:for-item="reply" wx:key="id" class="reply-item">
            <view class="reply-avatar">
              <text class="avatar-emoji">{{reply.author.avatar}}</text>
            </view>
            <view class="reply-content">
              <view class="reply-meta">
                <text class="author-name">{{reply.author.name}}</text>
                <text wx:if="{{reply.replyTo}}" class="reply-to">å›å¤ @{{reply.replyTo}}</text>
                <text class="reply-time">{{formatTime(reply.createdAt)}}</text>
              </view>
              <view class="reply-text">{{reply.content}}</view>
              <view class="reply-actions">
                <view 
                  class="action-reply"
                  bindtap="replyToComment"
                  data-id="{{reply.id}}"
                  data-name="{{reply.author.name}}"
                >
                  <text class="reply-icon">â†©ï¸</text>
                  <text class="reply-text">å›å¤</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{hasMore}}" class="load-more">
        <button 
          class="load-more-btn {{loading ? 'loading' : ''}}"
          bindtap="loadMoreComments"
          disabled="{{loading}}"
        >
          <text wx:if="{{loading}}" class="loading-icon">â³</text>
          <text class="btn-text">{{loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}</text>
        </button>
      </view>
    </view>
  </view>
</view>