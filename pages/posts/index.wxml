<!--pages/posts/index.wxml-->
<view class="page-bg"></view>
<view class="container theme-transition" style="opacity: {{themeOpacity}}">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="page-header-content">
      <view class="page-title">å¢¨è¯­Â·Light & Ink</view>
      <view class="page-subtitle">å‘ç°ç²¾å½©å†…å®¹ï¼Œåˆ†äº«çŸ¥è¯†è§è§£</view>
      
      <!-- æ—¶é—´é—®å€™ -->
      <view wx:if="{{showTimeGreeting}}" class="time-greeting">
        <text class="greeting-text">{{timeGreeting}}</text>
      </view>
      
      <!-- æƒ…æ„ŸåŒ–é—®å€™ -->
      <view wx:if="{{showEmotionalGreeting && emotionalGreeting}}" class="emotional-greeting">
        <!-- ä¸»è¦é—®å€™ä¿¡æ¯ -->
        <view class="greeting-primary">
          <text class="greeting-title">{{emotionalGreeting.primary.title}}</text>
          <text class="greeting-message">{{emotionalGreeting.primary.message}}</text>
        </view>
        
        <!-- ä½œè€…çŠ¶æ€ -->
        <view wx:if="{{authorStatus}}" class="author-status" bindtap="refreshEmotionalGreeting">
          <text class="status-emoji">{{authorStatus.emoji}}</text>
          <view class="status-info">
            <text class="status-name">ä½œè€…{{authorStatus.name}}</text>
            <text class="status-message">{{authorStatus.message}}</text>
            <text class="status-time">{{authorStatus.timeLeft}}</text>
          </view>
        </view>
        
        <!-- ç‰¹æ®Šæ—¥æœŸå½©è›‹ -->
        <view wx:if="{{specialDateEgg}}" class="special-date-egg">
          <text class="egg-emoji">{{specialDateEgg.emoji}}</text>
          <text class="egg-message">{{specialDateEgg.message}}</text>
        </view>
        
        <!-- æ·±å¤œé˜…è¯»æé†’ -->
        <view wx:if="{{midnightReaderEgg}}" class="midnight-reader-egg">
          <text class="midnight-message">{{midnightReaderEgg.message}}</text>
          <text class="midnight-advice">{{midnightReaderEgg.advice}}</text>
        </view>
        
        <!-- é¼“åŠ±è¯­æŒ‰é’® -->
        <view class="encouragement-btn" bindtap="getRandomEncouragement">
          <text class="btn-text">âœ¨ è·å–é¼“åŠ±</text>
        </view>
      </view>
      
      <!-- ä¸€è¨€å±•ç¤º -->
      <view wx:if="{{hitokoto}}" class="hitokoto-container">
        <view class="hitokoto-content" bindtap="refreshHitokoto">
          <text class="hitokoto-text">{{hitokoto.content}}</text>
          <view class="hitokoto-author">
            <text>â€”â€” {{hitokoto.author}}ã€Š{{hitokoto.source}}ã€‹</text>
          </view>
        </view>
        <view class="hitokoto-refresh">
          <text class="refresh-hint">è½»è§¦åˆ·æ–°</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-container">
    <view class="search-box">
      <input 
        class="search-input" 
        placeholder="æœç´¢" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
        bindfocus="onSearchFocus"
        bindblur="onSearchBlur"
      />
      <view class="search-btn" bindtap="onSearch">
        <text class="iconfont icon-search">ğŸ”</text>
      </view>
    </view>
    
    <!-- æœç´¢å†å² -->
    <view wx:if="{{showSearchHistory && searchHistory.length > 0}}" class="search-history">
      <view class="search-history-header">
        <text class="history-title">æœç´¢å†å²</text>
        <text class="clear-history" bindtap="clearSearchHistory">æ¸…ç©º</text>
      </view>
      <view class="history-tags">
        <view 
          wx:for="{{searchHistory}}" 
          wx:key="*this"
          class="history-tag"
          bindtap="onHistoryTap"
          data-keyword="{{item}}"
        >
          {{item}}
        </view>
      </view>
    </view>
  </view>



  <!-- ç­›é€‰æ  -->
  <view class="filter-container">
    <view class="filter-bar">
      <view 
        class="filter-item {{selectedCategory === '' ? 'active' : ''}}"
        bindtap="onCategorySelect"
        data-category=""
      >
        å…¨éƒ¨
      </view>
      <scroll-view class="filter-scroll" scroll-x="{{enableCategoryScroll}}" show-scrollbar="false">
        <view class="filter-categories">
          <view 
            wx:for="{{categories}}" 
            wx:key="name"
            class="filter-item {{selectedCategory === item.name ? 'active' : ''}}"
            bindtap="onCategorySelect"
            data-category="{{item.name}}"
          >
            {{item.name}} ({{item.count}})
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- æ ‡ç­¾ç­›é€‰ -->
  <view wx:if="{{showTagFilter}}" class="tags mb-30">
    <view 
      class="tag {{selectedTag === '' ? 'active' : ''}}"
      bindtap="onTagSelect"
      data-tag=""
    >
      å…¨éƒ¨æ ‡ç­¾
    </view>
    <view 
      wx:for="{{tags}}" 
      wx:key="name"
      class="tag {{selectedTag === item.name ? 'active' : ''}}"
      bindtap="onTagSelect"
      data-tag="{{item.name}}"
      style="background-color: {{item.color || 'var(--color-hover)'}}"
    >
      {{item.name}} ({{item.count}})
    </view>
  </view>

  <!-- æ ‡ç­¾ç­›é€‰å¼€å…³ -->
  <view class="flex-between mb-20">
    <view class="tag-toggle-btn" bindtap="toggleTagFilter">
      <text class="toggle-text">{{showTagFilter ? 'éšè—æ ‡ç­¾' : 'æ˜¾ç¤ºæ ‡ç­¾'}}</text>
      <text class="toggle-arrow"></text>
    </view>
    <view class="text-right" style="font-size: 24rpx; color: var(--color-text-secondary);">
      å…± {{total}} ç¯‡æ–‡ç« 
    </view>
  </view>

  <!-- æ–‡ç« åˆ—è¡¨ -->
  <view wx:if="{{!loading && posts.length > 0}}">
    <view 
      wx:for="{{posts}}" 
      wx:key="id"
      class="post-card"
      bindtap="onPostTap"
      data-slug="{{item.slug}}"
      data-id="{{item.id}}"
    >
      <!-- æ–‡ç« å°é¢ -->
      <image 
        wx:if="{{item.pageCoverThumbnail}}"
        class="post-cover" 
        src="{{item.pageCoverThumbnail}}" 
        mode="aspectFill"
        lazy-load
      />
      
      <view class="post-content">
        <!-- æ–‡ç« æ ‡é¢˜ -->
        <view class="post-title">{{item.title}}</view>
        
        <!-- æ–‡ç« æ‘˜è¦ -->
        <view wx:if="{{item.summary}}" class="post-summary">
          {{item.summary}}
        </view>
        
        <!-- æ–‡ç« æ ‡ç­¾ -->
        <view wx:if="{{item.tags && item.tags.length > 0}}" class="tags">
          <view 
            wx:for="{{item.tags}}" 
            wx:for-item="tag"
            wx:for-index="tagIndex"
            wx:key="*this"
            class="tag"
            style="background-color: {{tag.color || 'var(--color-hover)'}}"
          >
            {{tag.name || tag}}
          </view>
        </view>
        
        <!-- æ–‡ç« å…ƒä¿¡æ¯ -->
        <view class="post-meta">
          <view class="post-date">
            ğŸ“… {{item.publishDay || item.publishDate}}
          </view>
          <view wx:if="{{item.category}}" class="post-category">
            {{item.category}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- éª¨æ¶å±åŠ è½½ -->
  <view wx:if="{{showSkeleton}}" class="skeleton-container">
    <view wx:for="{{[1,2,3]}}" wx:key="*this" class="skeleton-card">
      <view class="skeleton-line"></view>
      <view class="skeleton-line medium"></view>
      <view class="skeleton-line short"></view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!loading && posts.length === 0}}" class="empty">
    <view class="empty-icon">ğŸ“</view>
    <view class="empty-text">
      {{searchKeyword || selectedCategory || selectedTag ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« ' : 'æš‚æ— æ–‡ç« '}}
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view 
    wx:if="{{!loading && posts.length > 0 && hasMore}}"
    class="btn btn-outline"
    style="width: 100%; margin-top: 40rpx;"
    bindtap="loadMore"
  >
    <view wx:if="{{loadingMore}}" class="loading-pulse">
      <view class="pulse-dot"></view>
      <view class="pulse-dot"></view>
      <view class="pulse-dot"></view>
    </view>
    <text wx:else>åŠ è½½æ›´å¤š</text>
  </view>

  <!-- æ²¡æœ‰æ›´å¤š -->
  <view 
    wx:if="{{!loading && posts.length > 0 && !hasMore}}"
    class="text-center mt-30"
    style="color: var(--color-text-secondary); font-size: 24rpx;"
  >
    æ²¡æœ‰æ›´å¤šæ–‡ç« äº†
  </view>
</view>