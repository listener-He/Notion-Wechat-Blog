<!--pages/posts/index.wxml-->
<view class="container theme-transition" style="opacity: {{themeOpacity}}">
  <!-- 页面头部 -->
  <view class="page-header">
    <view class="page-header-content">
      <view class="page-title">墨语·Light & Ink</view>
      <view class="page-subtitle">发现精彩内容，分享知识见解</view>
      
      <!-- 时间问候 -->
      <view wx:if="{{showTimeGreeting}}" class="time-greeting">
        <text class="greeting-text">{{timeGreeting}}</text>
      </view>
      
      <!-- 情感化问候 -->
      <view wx:if="{{showEmotionalGreeting && emotionalGreeting}}" class="emotional-greeting">
        <!-- 主要问候信息 -->
        <view class="greeting-primary">
          <text class="greeting-title">{{emotionalGreeting.primary.title}}</text>
          <text class="greeting-message">{{emotionalGreeting.primary.message}}</text>
        </view>
        
        <!-- 作者状态 -->
        <view wx:if="{{authorStatus}}" class="author-status" bindtap="refreshEmotionalGreeting">
          <text class="status-emoji">{{authorStatus.emoji}}</text>
          <view class="status-info">
            <text class="status-name">作者{{authorStatus.name}}</text>
            <text class="status-message">{{authorStatus.message}}</text>
            <text class="status-time">{{authorStatus.timeLeft}}</text>
          </view>
        </view>
        
        <!-- 特殊日期彩蛋 -->
        <view wx:if="{{specialDateEgg}}" class="special-date-egg">
          <text class="egg-emoji">{{specialDateEgg.emoji}}</text>
          <text class="egg-message">{{specialDateEgg.message}}</text>
        </view>
        
        <!-- 深夜阅读提醒 -->
        <view wx:if="{{midnightReaderEgg}}" class="midnight-reader-egg">
          <text class="midnight-message">{{midnightReaderEgg.message}}</text>
          <text class="midnight-advice">{{midnightReaderEgg.advice}}</text>
        </view>
        
        <!-- 鼓励语按钮 -->
        <view class="encouragement-btn" bindtap="getRandomEncouragement">
          <text class="btn-text">✨ 获取鼓励</text>
        </view>
      </view>
      
      <!-- 一言展示 -->
      <view wx:if="{{hitokoto}}" class="hitokoto-container">
        <view class="hitokoto-content" bindtap="refreshHitokoto">
          <text class="hitokoto-text">{{hitokoto.content}}</text>
          <view class="hitokoto-author">
            <text>—— {{hitokoto.author}}《{{hitokoto.source}}》</text>
          </view>
        </view>
        <view class="hitokoto-refresh">
          <text class="refresh-hint">轻触刷新</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 搜索框 -->
  <view class="search-container">
    <view class="search-box">
      <input 
        class="search-input" 
        placeholder="搜索" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
        bindfocus="onSearchFocus"
        bindblur="onSearchBlur"
      />
      <view class="search-btn" bindtap="onSearch">
        <icon name="search" size="28" color="var(--theme-text-primary)" />
      </view>
    </view>
    
    <!-- 搜索历史 -->
    <view wx:if="{{showSearchHistory && searchHistory.length > 0}}" class="search-history">
      <view class="search-history-header">
        <text class="history-title">搜索历史</text>
        <text class="clear-history" bindtap="clearSearchHistory">清空</text>
      </view>
      <view class="history-tags">
        <view 
          wx:for="{{searchHistory}}" 
          wx:key="*this"
          class="history-tag"
          bindtap="onHistoryTap"
          data-keyword="{{item}}"
        >
          {{item}}
        </view>
      </view>
    </view>
  </view>



  <!-- 筛选栏 -->
  <view class="filter-container">
    <view class="filter-bar">
      <view 
        class="filter-item {{selectedCategory === '' ? 'active' : ''}}"
        bindtap="onCategorySelect"
        data-category=""
      >
        全部
      </view>
      <scroll-view class="filter-scroll" scroll-x="{{enableCategoryScroll}}" show-scrollbar="false">
        <view class="filter-categories">
          <view 
            wx:for="{{categories}}" 
            wx:key="name"
            class="filter-item {{selectedCategory === item.name ? 'active' : ''}}"
            bindtap="onCategorySelect"
            data-category="{{item.name}}"
          >
            {{item.name}} ({{item.count}})
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 标签筛选 -->
  <view wx:if="{{showTagFilter}}" class="tags mb-30">
    <view 
      class="tag {{selectedTag === '' ? 'active' : ''}}"
      bindtap="onTagSelect"
      data-tag=""
    >
      全部标签
    </view>
    <view 
      wx:for="{{tags}}" 
      wx:key="name"
      class="tag {{selectedTag === item.name ? 'active' : ''}}"
      bindtap="onTagSelect"
      data-tag="{{item.name}}"
      style="background-color: {{item.color || 'var(--theme-bg-tertiary)'}}"
    >
      {{item.name}} ({{item.count}})
    </view>
  </view>

  <!-- 标签筛选开关 -->
  <view class="flex-between mb-20">
    <view class="tag-toggle-btn" bindtap="toggleTagFilter">
      <text class="toggle-text">{{showTagFilter ? '隐藏标签' : '显示标签'}}</text>
      <text class="toggle-arrow"></text>
    </view>
    <view class="text-right" style="font-size: 24rpx; color: var(--theme-text-secondary);">
      共 {{total}} 篇文章
    </view>
  </view>

  <!-- 文章列表 -->
  <view wx:if="{{!loading && posts.length > 0}}">
    <view 
      wx:for="{{posts}}" 
      wx:key="id"
      class="post-card"
      bindtap="onPostTap"
      data-slug="{{item.slug}}"
      data-id="{{item.id}}"
    >
      <!-- 文章封面 -->
      <image 
        wx:if="{{item.pageCoverThumbnail}}"
        class="post-cover" 
        src="{{item.pageCoverThumbnail}}" 
        mode="aspectFill"
        lazy-load
      />
      
      <view class="post-content">
        <!-- 文章标题 -->
        <view class="post-title">{{item.title}}</view>
        
        <!-- 文章摘要 -->
        <view wx:if="{{item.summary}}" class="post-summary">
          {{item.summary}}
        </view>
        
        <!-- 文章标签 -->
        <view wx:if="{{item.tags && item.tags.length > 0}}" class="tags">
          <view 
            wx:for="{{item.tags}}" 
            wx:for-item="tag"
            wx:for-index="tagIndex"
            wx:key="*this"
            class="tag"
            style="background-color: {{tag.color || 'var(--theme-bg-tertiary)'}}"
          >
            {{tag.name || tag}}
          </view>
        </view>
        
        <!-- 文章元信息 -->
        <view class="post-meta">
          <view class="post-date">
            <icon name="calendar" size="24" color="var(--theme-text-secondary)" /> {{item.publishDay || item.publishDate}}
          </view>
          <view wx:if="{{item.category}}" class="post-category">
            {{item.category}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
    <view class="loading-text">加载中...</view>
  </view>

  <!-- 骨架屏加载 -->
  <view wx:if="{{showSkeleton}}" class="skeleton-container">
    <view wx:for="{{[1,2,3]}}" wx:key="*this" class="skeleton-card">
      <view class="skeleton-line"></view>
      <view class="skeleton-line medium"></view>
      <view class="skeleton-line short"></view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:if="{{!loading && posts.length === 0}}" class="empty">
    <icon name="edit" size="48" color="var(--theme-text-secondary)" />
    <view class="empty-text">
      {{searchKeyword || selectedCategory || selectedTag ? '没有找到相关文章' : '暂无文章'}}
    </view>
  </view>

  <!-- 加载更多 -->
  <view 
    wx:if="{{!loading && posts.length > 0 && hasMore}}"
    class="btn btn-outline"
    style="width: 100%; margin-top: 40rpx;"
    bindtap="loadMore"
  >
    <view wx:if="{{loadingMore}}" class="loading-pulse">
      <view class="pulse-dot"></view>
      <view class="pulse-dot"></view>
      <view class="pulse-dot"></view>
    </view>
    <text wx:else>加载更多</text>
  </view>

  <!-- 没有更多 -->
  <view 
    wx:if="{{!loading && posts.length > 0 && !hasMore}}"
    class="text-center mt-30"
    style="color: var(--theme-text-secondary); font-size: 24rpx;"
  >
    没有更多文章了
  </view>
</view>
