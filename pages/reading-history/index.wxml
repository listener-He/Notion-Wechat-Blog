<!--pages/reading-history/index.wxml-->
<view class="reading-history-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">é˜…è¯»è¶³è¿¹</text>
    <text class="page-subtitle">è®°å½•ä½ çš„é˜…è¯»æ—¶å…‰</text>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-nav">
    <view class="tab-item {{activeTab === 'history' ? 'active' : ''}}" 
          data-tab="history" bindtap="onTabChange">
      <text class="tab-text">é˜…è¯»å†å²</text>
      <view class="tab-badge" wx:if="{{historyList.length > 0}}">{{historyList.length}}</view>
    </view>
    <view class="tab-item {{activeTab === 'favorites' ? 'active' : ''}}" 
          data-tab="favorites" bindtap="onTabChange">
      <text class="tab-text">æˆ‘çš„æ”¶è—</text>
      <view class="tab-badge" wx:if="{{favoritesList.length > 0}}">{{favoritesList.length}}</view>
    </view>
    <view class="tab-item {{activeTab === 'stats' ? 'active' : ''}}" 
          data-tab="stats" bindtap="onTabChange">
      <text class="tab-text">é˜…è¯»ç»Ÿè®¡</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:if="{{error && !loading}}">
    <view class="error-icon">âš ï¸</view>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" bindtap="retry">é‡è¯•</button>
  </view>

  <!-- é˜…è¯»å†å²æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'history' && !loading && !error}}">
    <!-- å·¥å…·æ  -->
    <view class="toolbar" wx:if="{{historyList.length > 0}}">
      <view class="sort-options">
        <text class="toolbar-label">æ’åºï¼š</text>
        <view class="sort-item {{sortBy === 'time' ? 'active' : ''}}" 
              data-sort="time" bindtap="onSortChange">
          <text>æ—¶é—´</text>
        </view>
        <view class="sort-item {{sortBy === 'readingTime' ? 'active' : ''}}" 
              data-sort="readingTime" bindtap="onSortChange">
          <text>é˜…è¯»æ—¶é•¿</text>
        </view>
        <view class="sort-item {{sortBy === 'category' ? 'active' : ''}}" 
              data-sort="category" bindtap="onSortChange">
          <text>åˆ†ç±»</text>
        </view>
      </view>
      <view class="toolbar-actions">
        <button class="filter-btn" bindtap="toggleFilter">ç­›é€‰</button>
        <button class="clear-btn" bindtap="onClearHistory">æ¸…ç©º</button>
      </view>
    </view>

    <!-- åˆ†ç±»ç­›é€‰ -->
    <view class="filter-panel" wx:if="{{showFilter}}">
      <view class="filter-title">æŒ‰åˆ†ç±»ç­›é€‰ï¼š</view>
      <view class="filter-tags">
        <view class="filter-tag {{filterCategory === '' ? 'active' : ''}}" 
              data-category="" bindtap="onCategoryFilter">
          <text>å…¨éƒ¨</text>
        </view>
        <view class="filter-tag {{filterCategory === item ? 'active' : ''}}" 
              wx:for="{{categories}}" wx:key="*this"
              data-category="{{item}}" bindtap="onCategoryFilter">
          <text>{{item}}</text>
        </view>
      </view>
    </view>

    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <view class="history-list" wx:if="{{historyList.length > 0}}">
      <view class="history-item entrance-animation" 
            wx:for="{{historyList}}" wx:key="id"
            wx:if="{{!filterCategory || item.category === filterCategory}}"
            data-slug="{{item.slug}}" data-id="{{item.id}}" 
            bindtap="onPostTap">
        <view class="item-content">
          <view class="item-header">
            <text class="item-title">{{item.title}}</text>
            <view class="item-actions">
              <button class="delete-btn" 
                      data-id="{{item.id}}" data-slug="{{item.slug}}"
                      bindtap="onDeleteHistory" catchtap="true">
                åˆ é™¤
              </button>
            </view>
          </view>
          <view class="item-meta">
            <text class="item-category" wx:if="{{item.category}}">{{item.category}}</text>
            <text class="item-time">{{item.formattedTime}}</text>
            <text class="item-reading-time" wx:if="{{item.readingTime}}">
              é˜…è¯» {{item.formattedReadingTime}}
            </text>
          </view>
          <text class="item-excerpt" wx:if="{{item.excerpt}}">{{item.excerpt}}</text>
        </view>
        <view class="item-indicator">
          <text class="relative-time">{{item.relativeTime}}</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{historyList.length === 0}}">
      <view class="empty-icon">ğŸ“š</view>
      <text class="empty-title">è¿˜æ²¡æœ‰é˜…è¯»è®°å½•</text>
      <text class="empty-subtitle">å¼€å§‹é˜…è¯»æ–‡ç« ï¼Œè®°å½•ä½ çš„é˜…è¯»è¶³è¿¹å§</text>
    </view>
  </view>

  <!-- æ”¶è—æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'favorites' && !loading && !error}}">
    <!-- å·¥å…·æ  -->
    <view class="toolbar" wx:if="{{favoritesList.length > 0}}">
      <view class="toolbar-info">
        <text class="info-text">å…± {{favoritesList.length}} ç¯‡æ”¶è—</text>
      </view>
      <view class="toolbar-actions">
        <button class="clear-btn" bindtap="onClearFavorites">æ¸…ç©º</button>
      </view>
    </view>

    <!-- æ”¶è—åˆ—è¡¨ -->
    <view class="favorites-list" wx:if="{{favoritesList.length > 0}}">
      <view class="favorite-item entrance-animation" 
            wx:for="{{favoritesList}}" wx:key="id"
            data-slug="{{item.slug}}" data-id="{{item.id}}" 
            bindtap="onPostTap">
        <view class="item-content">
          <view class="item-header">
            <text class="item-title">{{item.title}}</text>
            <view class="item-actions">
              <button class="unfavorite-btn" 
                      data-id="{{item.id}}" data-slug="{{item.slug}}"
                      bindtap="onRemoveFavorite" catchtap="true">
                å–æ¶ˆæ”¶è—
              </button>
            </view>
          </view>
          <view class="item-meta">
            <text class="item-category" wx:if="{{item.category}}">{{item.category}}</text>
            <text class="item-time">æ”¶è—äº {{item.formattedTime}}</text>
          </view>
          <text class="item-excerpt" wx:if="{{item.excerpt}}">{{item.excerpt}}</text>
        </view>
        <view class="favorite-indicator">
          <text class="favorite-icon">â¤ï¸</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{favoritesList.length === 0}}">
      <view class="empty-icon">â¤ï¸</view>
      <text class="empty-title">è¿˜æ²¡æœ‰æ”¶è—æ–‡ç« </text>
      <text class="empty-subtitle">æ”¶è—å–œæ¬¢çš„æ–‡ç« ï¼Œæ–¹ä¾¿éšæ—¶å›é¡¾</text>
    </view>
  </view>

  <!-- ç»Ÿè®¡æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{activeTab === 'stats' && !loading && !error}}">
    <view class="stats-container">
      <!-- æ€»ä½“ç»Ÿè®¡ -->
      <view class="stats-section">
        <text class="section-title">æ€»ä½“ç»Ÿè®¡</text>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{readingStats.totalArticles}}</text>
            <text class="stat-label">é˜…è¯»æ–‡ç« </text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{readingStats.favoriteCount}}</text>
            <text class="stat-label">æ”¶è—æ–‡ç« </text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{readingStats.totalReadingTime}}</text>
            <text class="stat-label">æ€»é˜…è¯»æ—¶é•¿</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{readingStats.averageReadingTime}}</text>
            <text class="stat-label">å¹³å‡é˜…è¯»æ—¶é•¿</text>
          </view>
        </view>
      </view>

      <!-- é˜…è¯»ä¹ æƒ¯ -->
      <view class="stats-section">
        <text class="section-title">é˜…è¯»ä¹ æƒ¯</text>
        <view class="habit-stats">
          <view class="habit-item">
            <text class="habit-label">æœ€é•¿é˜…è¯»æ—¶é•¿</text>
            <text class="habit-value">{{readingStats.longestSession}}</text>
          </view>
          <view class="habit-item" wx:if="{{readingStats.categoryStats}}">
            <text class="habit-label">æœ€å¸¸é˜…è¯»åˆ†ç±»</text>
            <view class="category-stats">
              <view class="category-item" 
                    wx:for="{{readingStats.categoryStats}}" 
                    wx:for-item="stat" wx:for-index="category" wx:key="category">
                <text class="category-name">{{category}}</text>
                <text class="category-count">{{stat.count}}ç¯‡</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æœˆåº¦ç»Ÿè®¡ -->
      <view class="stats-section" wx:if="{{readingStats.monthlyStats}}">
        <text class="section-title">æœˆåº¦ç»Ÿè®¡</text>
        <view class="monthly-stats">
          <view class="month-item" 
                wx:for="{{readingStats.monthlyStats}}" 
                wx:for-item="stat" wx:for-index="month" wx:key="month">
            <text class="month-name">{{month}}</text>
            <view class="month-data">
              <text class="month-count">{{stat.count}}ç¯‡</text>
              <text class="month-time">{{stat.totalTime}}åˆ†é’Ÿ</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>