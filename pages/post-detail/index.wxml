<!--pages/post-detail/index.wxml-->
<view class="container theme-transition" style="opacity: {{themeOpacity}}">
  <!-- é˜…è¯»è¿‡æ¸¡ç•Œé¢ -->
  <view wx:if="{{showTransition}}" class="reading-transition">
    <view class="transition-content">
      <view class="transition-icon">ğŸ“–</view>
      <view class="transition-title">å‡†å¤‡é˜…è¯»</view>
      <view wx:if="{{transitionQuote.content}}" class="transition-quote">
        <view class="quote-text">{{transitionQuote.content}}</view>
        <view wx:if="{{transitionQuote.author}}" class="quote-author">â€” {{transitionQuote.author}}</view>
      </view>
      <view class="transition-loading">
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
      </view>
    </view>
  </view>

  <!-- é˜…è¯»è¿›åº¦æ¡ -->
  <reading-progress wx:if="{{!showTransition}}" progress="{{readingProgress}}" />

  <!-- é˜…è¯»å®Œæˆå½©è›‹å¼¹æ¡† -->
  <view wx:if="{{showReadingComplete}}" class="reading-egg-modal" bindtap="hideReadingComplete">
    <!-- ç¤¼èŠ±èƒŒæ™¯åŠ¨ç”» -->
    <view class="fireworks-container">
      <view class="firework firework-1"></view>
      <view class="firework firework-2"></view>
      <view class="firework firework-3"></view>
      <view class="firework firework-4"></view>
      <view class="firework firework-5"></view>
      <view class="firework firework-6"></view>
    </view>
    
    <!-- å½©è›‹å†…å®¹ -->
    <view class="egg-content" catchtap="preventClose">
      <!-- å€’è®¡æ—¶åœ†ç¯ -->
      <view class="countdown-ring">
        <view class="countdown-text">{{countdownSeconds}}</view>
        <view class="countdown-progress" style="stroke-dasharray: {{countdownProgress}}, 283"></view>
      </view>
      
      <!-- å½©è›‹å›¾æ ‡ -->
      <view class="egg-icon">ğŸŠ</view>
      
      <!-- å½©è›‹æ ‡é¢˜ -->
      <view class="egg-title">é˜…è¯»å®Œæˆï¼</view>
      
      <!-- å½©è›‹è¯­å¥ -->
      <view wx:if="{{completeQuote.content}}" class="egg-quote">
        <view class="quote-content">{{completeQuote.content}}</view>
        <view wx:if="{{completeQuote.author}}" class="quote-author">â€” {{completeQuote.author}}</view>
      </view>
      
      <!-- é˜…è¯»ç»Ÿè®¡ -->
      <view wx:if="{{readingCompleteEgg}}" class="reading-stats">
        <view class="stat-item">
          <text class="stat-icon">â±ï¸</text>
          <text class="stat-text">é˜…è¯»æ—¶é•¿ {{readingCompleteEgg.readingTime}}ç§’</text>
        </view>
        <view class="stat-item">
          <text class="stat-icon">{{readingCompleteEgg.egg.emoji}}</text>
          <text class="stat-text">{{readingCompleteEgg.egg.message}}</text>
        </view>
      </view>
      
      <!-- å…³é—­æç¤º -->
      <view class="close-hint">{{countdownSeconds}}ç§’åè‡ªåŠ¨å…³é—­ï¼Œæˆ–ç‚¹å‡»ä»»æ„å¤„å…³é—­</view>
    </view>
  </view>
  <!-- æ–‡ç« å¤´éƒ¨èƒŒæ™¯ -->
  <view wx:if="{{post && post.title}}" class="post-header">
    <!-- èƒŒæ™¯å°é¢å›¾ -->
    <view class="header-bg">
      <image 
        wx:if="{{post.pageCover}}"
        class="bg-cover" 
        src="{{post.pageCover}}" 
        mode="aspectFill"
        lazy-load
      />
      <view wx:else class="default-bg"></view>
      <view class="bg-overlay"></view>
    </view>
    
    <!-- å¤´éƒ¨å†…å®¹ -->
    <view class="header-content">
      <!-- æ–‡ç« å›¾æ ‡ -->
      <view wx:if="{{post.pageIcon}}" class="post-icon">{{post.pageIcon}}</view>
      
      <!-- æ–‡ç« æ ‡é¢˜ -->
      <view class="post-title">{{post.title}}</view>
      
      <!-- æ–‡ç« æ‘˜è¦ -->
      <view wx:if="{{post.summary}}" class="post-summary">{{post.summary}}</view>
      
      <!-- æ–‡ç« æ ‡ç­¾ -->
      <view wx:if="{{post.tags && post.tags.length > 0}}" class="post-tags">
        <view 
          wx:for="{{post.tags}}" 
          wx:key="*this"
          class="tag"
          style="background-color: {{item.color || 'rgba(255,255,255,0.2)'}}"
        >
          {{item.name || item}}
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ–‡ç« å…ƒä¿¡æ¯å¡ç‰‡ -->
  <view wx:if="{{post && post.title}}" class="post-meta-card">
    <view class="meta-row">
      <view class="meta-item">
        <icon name="calendar" size="28" color="var(--theme-text-primary)" />
        <view class="meta-content">
          <text class="meta-label">å‘å¸ƒæ—¶é—´</text>
          <text class="meta-value">{{post.publishDate}}</text>
        </view>
      </view>
      <view wx:if="{{post.lastEditedDate && post.lastEditedDate !== post.publishDate}}" class="meta-item">
        <icon name="edit" size="28" color="var(--theme-text-primary)" />
        <view class="meta-content">
          <text class="meta-label">æœ€åç¼–è¾‘</text>
          <text class="meta-value">{{post.lastEditedDate}}</text>
        </view>
      </view>
    </view>
    
    <view class="meta-row">
      <view wx:if="{{post.category}}" class="meta-item">
        <icon name="folder" size="28" color="var(--theme-text-primary)" />
        <view class="meta-content">
          <text class="meta-label">åˆ†ç±»</text>
          <text class="meta-value">{{post.category}}</text>
        </view>
      </view>
      <view wx:if="{{post.wordCount}}" class="meta-item">
        <icon name="chart" size="28" color="var(--theme-text-primary)" />
        <view class="meta-content">
          <text class="meta-label">å­—æ•°ç»Ÿè®¡</text>
          <text class="meta-value">{{post.wordCount}} å­—</text>
        </view>
      </view>
    </view>
    
    <view wx:if="{{post.readingTime}}" class="meta-row">
      <view class="meta-item full-width">
        <icon name="clock" size="28" color="var(--theme-text-primary)" />
        <view class="meta-content">
          <text class="meta-label">é¢„è®¡é˜…è¯»æ—¶é—´</text>
          <text class="meta-value">{{post.readingTime}} åˆ†é’Ÿ</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ–‡ç« å†…å®¹ -->
  <towxml wx:if="{{parsedContent}}" nodes="{{parsedContent}}" class="post-content post-content-full" />
  <rich-text wx:elif="{{post.content}}" nodes="{{post.content}}" class="post-content post-content-full" />
  <view wx:else class="no-content">æš‚æ— å†…å®¹</view>
  
  <!-- ç‰ˆæƒä¿¡æ¯ -->
  <view wx:if="{{post && post.title}}" class="copyright">
    <view class="copyright-title">ğŸ“„ ç‰ˆæƒå£°æ˜</view>
    <view class="copyright-content">
      <view class="copyright-item">
        <text class="copyright-label">æœ¬æ–‡ä½œè€…ï¼š</text>
        <text class="copyright-value">{{post.author || 'åšä¸»'}}</text>
      </view>
      <view class="copyright-item">
        <text class="copyright-label">æœ¬æ–‡é“¾æ¥ï¼š</text>
        <text class="copyright-value">{{post.url || ''}}</text>
      </view>
      <view class="copyright-item">
        <text class="copyright-label">ç‰ˆæƒå£°æ˜ï¼š</text>
        <text class="copyright-value">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ CC BY-NC-SA 4.0 è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</text>
      </view>
    </view>
  </view>
  
  <!-- ç›¸å…³æ–‡ç«  -->
  <view wx:if="{{relatedPosts && relatedPosts.length > 0}}" class="related-posts">
    <view class="section-title">ğŸ“– ç›¸å…³æ–‡ç« </view>
    <view class="related-list">
      <view 
        wx:for="{{relatedPosts}}" 
        wx:key="id"
        class="related-item"
        bindtap="onRelatedPostTap"
        data-slug="{{item.slug}}"
        data-id="{{item.id}}"
      >
        <image 
          wx:if="{{item.pageCoverThumbnail}}"
          class="related-cover" 
          src="{{item.pageCoverThumbnail}}" 
          mode="aspectFill"
          lazy-load
        />
        <view class="related-info">
          <view class="related-title">{{item.title}}</view>
          <view class="related-date">{{item.publishDate}}</view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>
  
  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:if="{{error}}" class="error">
    <view class="error-icon">ğŸ˜•</view>
    <view class="error-text">{{error}}</view>
    <button class="btn btn-primary" bindtap="retry">é‡è¯•</button>
  </view>
  
  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!loading && !error && !post}}" class="empty">
    <view class="empty-icon">ğŸ“„</view>
    <view class="empty-text">æ–‡ç« ä¸å­˜åœ¨</view>
    <button class="btn btn-secondary" bindtap="goBack">è¿”å›</button>
  </view>
  
  <!-- è¯„è®ºåŒºåŸŸ -->
  <artalk-comment 
    wx:if="{{post && post.title}}" 
    page-key="{{post.slug || post.id}}" 
    page-title="{{post.title}}"
    show="{{true}}"
  ></artalk-comment>
</view>

<!-- åº•éƒ¨æ“ä½œæ  -->
<view wx:if="{{post && post.title}}" class="bottom-actions">
  <button class="action-btn btn-hover btn-ripple" bindtap="goBack">
    <icon name="arrowLeft" size="28" color="var(--theme-text-primary)" />
    <text class="action-text">è¿”å›</text>
  </button>
  
  <button class="action-btn btn-hover btn-ripple" open-type="share">
    <icon name="share" size="28" color="var(--theme-text-primary)" />
    <text class="action-text">åˆ†äº«</text>
  </button>
  
  <button class="action-btn btn-hover btn-ripple {{isFavorite ? 'like-heart' : ''}}" bindtap="toggleFavorite">
    <icon name="heart" size="28" color="{{isFavorite ? '#e0245e' : 'var(--theme-text-primary)'}}" />
    <text class="action-text">{{isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
  </button>
  
  <button class="action-btn btn-hover btn-ripple" bindtap="toggleThemeQuick">
    <icon name="chart" size="28" color="var(--theme-text-primary)" />
    <text class="action-text">ä¸»é¢˜</text>
  </button>
</view>
